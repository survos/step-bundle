{# file: templates/castor/logs_show.html.twig #}
{% extends '@SurvosStep/castor/_logger_layout.html.twig' %}

{% block title %}Log: {{ code }}{% endblock %}

{% block logger_body %}
  <div class="page-header d-flex align-items-center gap-2">
    <a href="{{ path('survos_castor_logs_index') }}" class="btn btn-outline-secondary btn-sm">‚Üê All logs</a>
    <h2 class="page-title mb-0">Log: <span class="fw-semibold">{{ code }}</span></h2>
  </div>
  <div class="text-muted mb-2">File: <code>{{ path }}</code></div>

  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-auto">
      <label class="form-label">Type</label>
      <select class="form-select" name="type">
        {% set types = ['', 'task_run_started','task_run_finished','process_created','process_started','process_terminated'] %}
        {% for t in types %}
          <option value="{{ t }}" {{ t == type ? 'selected' : '' }}>{{ t ?: 'Any' }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">Filter</label>
      <input type="text" class="form-control" name="q" value="{{ filter }}" placeholder="text search (case-insensitive)">
    </div>
    <div class="col-auto">
      <label class="form-label">Limit</label>
      <input type="number" class="form-control" name="limit" value="{{ limit }}" min="50" max="5000" step="50">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">Apply</button>
      <a class="btn btn-outline-secondary" href="{{ path('survos_castor_logs_raw', {code: code}) }}">Raw</a>
    </div>
  </form>

  {% if entries is empty %}
    <div class="alert alert-warning">No matching log entries.</div>
  {% else %}
    <div class="card">
      <div class="list-group list-group-flush">
        {% for e in entries %}
          <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                <span class="{{ e.badgeClass() }}">{{ e.type }}</span>
                {% if e.taskName %}
                  <code class="text-nowrap">{{ e.taskName }}</code>
                {% endif %}
                {% if e.cmdline %}
                  <code class="text-truncate" style="max-width: 50ch;">{{ e.cmdline }}</code>
                {% endif %}
              </div>
              <div class="text-end small text-muted">
                {{ e.ts ?? '-' }}
                {% if e.exitCode is not null %}
                  <span class="ms-2 badge {{ e.exitCode == 0 ? 'bg-success' : 'bg-danger' }}">exit {{ e.exitCode }}</span>
                {% endif %}
              </div>
            </div>

            <div class="mt-2 small">
              {% if e.castorFile %}
                <div>castor: <code>{{ e.castorFile }}</code></div>
              {% endif %}
              {% if e.workingDir %}
                <div>cwd: <code>{{ e.workingDir }}</code></div>
              {% endif %}
              {% if e.env is iterable %}
                <details class="mt-1">
                  <summary>env</summary>
                  <pre class="mb-0"><code>{{ e.env|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES')) }}</code></pre>
                </details>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="mt-3">
    <div class="small text-muted">Tip: <code>tail -f {{ path }}</code> to watch live.</div>
  </div>
{% endblock %}
